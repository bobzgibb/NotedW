<!DOCTYPE html>
<html>
  <head>
      <meta charset="UTF-8" />
      <title>BPMN.io BPMN diagram modeler - integrated with NotedW</title>

    <!-- required modeler styles -->
      <link rel="stylesheet" href="https://unpkg.com/bpmn-js@1.2.1/dist/assets/diagram-js.css">
      <link rel="stylesheet" href="https://unpkg.com/bpmn-js@1.2.1/dist/assets/bpmn-font/css/bpmn.css">

    <!-- modeler distro -->
      <script src="https://unpkg.com/bpmn-js@1.2.1/dist/bpmn-modeler.development.js"></script>

    <!-- needed for this example only -->
      <script src="https://unpkg.com/jquery@3.3.1/dist/jquery.js"></script>


    <!-- example styles -->
    <style>
      html, body, #canvas {
        height: 100%;
        padding: 0;
        margin: 0;
      }

      .diagram-note {
        background-color: rgba(66, 180, 21, 0.7);
        color: White;
        border-radius: 5px;
        font-family: Arial;
        font-size: 12px;
        padding: 5px;
        min-height: 16px;
        width: 50px;
        text-align: center;
      }

      .needs-discussion:not(.djs-connection) .djs-visual > :nth-child(1) {
        stroke: rgba(66, 180, 21, 0.7) !important; /* color elements as red */
      }

      #save-button {
        position: fixed;
        bottom: 20px;
        left: 20px;
      }
    </style>
  </head>
  <body>
    <div id="canvas"></div>
    
    <button id="save-button">save to NotedW</button>

    <script>

        window.onbeforeunload = function(){
            window.opener.postMessage("none","*" );
        }

        window.addEventListener("beforeunload", function(e){
            window.opener.postMessage("none","*" ); 
        }, false);

      var bpmnXML = localStorage.getItem("wiki.temp.bpmn");

      if (bpmnXML.length<6) {
          bpmnXML = '<?xml version="1.0" encoding="UTF-8"?><bpmn2:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bpmn2="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL BPMN20.xsd" id="sample-diagram" targetNamespace="http://bpmn.io/schema/bpmn"><bpmn2:process id="Process_1" isExecutable="false"></bpmn2:process><bpmndi:BPMNDiagram id="BPMNDiagram_1"><bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">    </bpmndi:BPMNPlane>  </bpmndi:BPMNDiagram></bpmn2:definitions>';
      } else {
          bpmnXML=bpmnXML.replace('<!--?xml version="1.0" encoding="UTF-8"?-->','<?xml version="1.0" encoding="UTF-8"?>')
      }
        
      console.log(bpmnXML);
      // modeler instance
      var bpmnModeler = new BpmnJS({
        container: '#canvas',
        keyboard: {
          bindTo: window
        }
      });

      /**
       * Save diagram contents and print them to the console.
       */
      function exportDiagram() {

        bpmnModeler.saveXML({ format: true }, function(err, xml) {

          if (err) {
            return console.error('could not save BPMN 2.0 diagram', err);
          }

          //alert(xml);
          var orig = window.opener;
          orig.postMessage(xml,"*" );
          window.self.close();    
          //console.log('DIAGRAM', xml);
        });
      }

      /**
       * Open diagram in our modeler instance.
       *
       * @param {String} bpmnXML diagram to display
       */
      function openDiagram(bpmnXML) {

        // import diagram
        bpmnModeler.importXML(bpmnXML, function(err) {

          if (err) {
            return console.error('could not import BPMN 2.0 diagram', err);
          }

          // access modeler components
          var canvas = bpmnModeler.get('canvas');
          var overlays = bpmnModeler.get('overlays');


          // zoom to fit full viewport
          canvas.zoom( 'fit-viewport');

        });
      }


      // load external diagram file via AJAX and open it
      //$.get(diagramUrl, openDiagram, 'text');
      openDiagram(bpmnXML);
      // wire save button
      $('#save-button').click(exportDiagram);
    </script>
    <!--
      Thanks for trying out our BPMN toolkit!

      This example uses the pre-built distribution of the bpmn-js modeler.
      Consider rolling your own distribution to have more flexibility
      regarding which features to include.

      Checkout our advanced examples section to learn more:
      * https://github.com/bpmn-io/bpmn-js-examples#advanced

      To get a bit broader overview over how bpmn-js works,
      follow our walkthrough:
      * https://bpmn.io/toolkit/bpmn-js/walkthrough/

      Related starters:
      * https://raw.githubusercontent.com/bpmn-io/bpmn-js-examples/starter/viewer.html
    -->
  </body>
</html>